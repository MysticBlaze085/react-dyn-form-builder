<div adk-selection #selection="adkSelection">
  <table *ngIf="(groupData.change$ | async) as groupData" aria-hidden="true"
    class="w-full text-left table-auto min-w-max">
    <thead>
      <ng-container
        *ngTemplateOutlet="renderThead; context: { groupData, headers: tdss.get('headers'), isSelectable, sortDataSource: tdss.get('sortDataSource')}, selection"></ng-container>
    </thead>
    <tbody>
      @for(groupKey of objectKeysGroupData(groupData); track $index){
      @if(groupBy && groupKey !== '') {
      <ng-container
        *ngTemplateOutlet="groupByRender; context: { groupData, headers, isSelectable, groupKey, selection }"></ng-container>
      } @else {
      @for(rowData of groupData[groupKey]; track $index) {
      <ng-container
        *ngTemplateOutlet="renderRow; context: { headers, rowData, rowIndex: $index, isSelectable, selection }"></ng-container>
      }
      }
      }
    </tbody>
  </table>
</div>

<!-- Render Table Header -->
<ng-template #renderThead let-groupData="groupData" let-header="headers" let-isSelectable="isSelectable"
  let-sortDataSource="sortDataSource" let-selection="selection">
  <tr>
    @if(isSelectable) {
    <th id="checkAll" class="border-b border-blue-gray-100 bg-blue-gray-50 p-1 max-w-[10px]">
      <ng-container
        *ngTemplateOutlet="checkBox; context: {selection, groupData, rowData: undefined, isCheckAll: true}"></ng-container>
    </th>
    }
    @for(header of headers; track $index) {
    <th [id]="header" class="border-b border-blue-gray-100 bg-blue-gray-50 p-3 cursor-pointer" [attr.key]="header"
      [ngClass]="{'border-b border-blue-gray-100 bg-blue-gray-50 p-3 cursor-pointer': true}"
      [attr.draggable]="isDraggable" (dragstart)="handleDragStart($index)" (dragover)="handleDragOver($event)"
      (drop)="handleDrop($index, $event)" (drop)="handleDrop($index, $event)" scope="col">
      <tw-typography [variant]="'small'"
        [classStyle]="'flex items-center justify-between gap-2 font-normal leading-none opacity-70'">
        {{ header ?? ' ' | uppercase}}
        <div class="flex flex-row gap-2">
          @if($index !== headers.length && isSortable) {
          <tw-sortable-icon (click)="sortRows(header)" (keydown)="sortRows(header)"></tw-sortable-icon>
          } @if(tdss.get('sortDataSource').key === header && isSortable) {
          <span>{{ sortDataSource.direction === 'ascending' ? 'ðŸ”¼' : 'ðŸ”½' }}</span>
          }
        </div>
      </tw-typography>
    </th>
    }
  </tr>
</ng-template>

<!-- Group By Render -->
<ng-template #groupByRender let-groupData="groupData" let-headers="headers" let-isSelectable="isSelectable"
  let-groupKey="groupKey" let-selection="selection">
  <tr>
    <td [colSpan]="headers.length + (isSelectable ? 1 : 0) + (actionButton ? 1 : 0)">
      <adk-expansion-panel>
        <ng-template #expansionPanelHeader>
          {{groupKey}}
        </ng-template>
        <ng-template #expansionPanelBody>
          <table aria-hidden="true" class="w-full min-w-max table-auto text-left">
            <tbody>
              @for(rowData of groupData[groupKey]; track $index) {
              <ng-container
                *ngTemplateOutlet="renderRow; context: { headers, rowData, rowIndex: $index, isSelectable, selection }">
              </ng-container>
              }
            </tbody>
          </table>
        </ng-template>
      </adk-expansion-panel>
    </td>
  </tr>
</ng-template>

<!-- Render Row Table Cells -->
<ng-template #renderRow let-header="headers" let-rowData="rowData" let-rowIndex="rowIndex"
  let-isSelectable="isSelectable" let-selection="selection">
  <tr [ngClass]="isSelected(rowData) ? 'bg-light-blue-50': ''" (click)="selectedRow.value = rowData">
    @if(isSelectable) {
    <td [ngClass]="isSelectable ? 'p-1' : 'p-4'" class="border-b border-blue-gray-50 p-1 max-h-[38px] max-w-[15px]">
      <ng-container
        *ngTemplateOutlet="checkBox; context: {selection, groupData: undefined, rowData, isCheckAll: false}"></ng-container>
    </td>
    }
    @for (header of headers; track $index) {
    <td [ngClass]="isSelectable ? 'p-1' : 'p-2'"
      class="border-b border-blue-gray-50 min-h-[48.5px] min-w-[60px] max-w-[60px] truncate">
      <div [adkTooltip]="rowData[header]" tooltipPlacement="bottom" [ngStyle]="{'cursor': 'text'}">
        @if(isCellValArray(rowData[header])) {
        @if(isSelectable && isMultiSelectField){
        <adk-field
          *ngIf="selection.selectedObj(rowData) && (cellMultiSelector(rowIndex, rowData[header]) | async) as field"
          [field]="field"></adk-field>
        } @else {
        <tw-typography [variant]="'small'" class="font-normal ml-2">
          {{ rowData[header].join(', ') }}
        </tw-typography>
        }
        } @else {
        @if (isCellFieldObject(rowData[header])) {
        <adk-field [field]="rowData[header]"></adk-field>
        } @else {
        <tw-typography [variant]="'small'" class="font-normal ml-2">
          {{ rowData[header] }}
        </tw-typography>
        }
        }
      </div>
    </td>
    }
  </tr>
</ng-template>

<!-- Checkbox Render -->
<ng-template #checkBox let-isCheckAll="isCheckAll" let-selection="selection" let-groupData="groupData"
  let-rowData="rowData">
  @if(isCheckAll) {
  <div class="inline-flex items-center">
    <label for="selectAllCheckbox" class="relative flex items-center p-3 rounded-full cursor-pointer">
      <input type="checkbox"
        class="before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-gray-900 checked:bg-gray-900 checked:before:bg-gray-900 hover:before:opacity-10 w-4 h-4"
        id="selectAllCheckbox" name="selectAllCheckbox" [checked]="allRowsSelected"
        (change)="toggleSelectAll($event, objectKeysGroupData(groupData))" />
      <span
        class="absolute text-white transition-opacity opacity-0 pointer-events-none top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 peer-checked:opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"
          stroke="currentColor" stroke-width="1">
          <path fill-rule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </span>
    </label>
  </div>
  } @else {
  <div class="inline-flex items-center">
    <label class="relative flex items-center p-3 rounded-full cursor-pointer" for="checkbox">
      <input type="checkbox"
        class="before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-gray-900 checked:bg-gray-900 checked:before:bg-gray-900 hover:before:opacity-10 w-4 h-4"
        [checked]="selection.selected(rowData)" (change)="toggleSelectItem(rowData)" />
      <span
        class="absolute text-white transition-opacity opacity-0 pointer-events-none top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 peer-checked:opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"
          stroke="currentColor" stroke-width="1">
          <path fill-rule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </span>
    </label>
  </div>
  }
</ng-template>